<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>PHP Manual: Set callback for connection close</title>

</head>
<body>
<table width="100%">
    <tr valign="top">
        <td style="font-size: smaller;" width="15%">
<style type="text/css">
#leftbar {
	float: left;
	width: 186px;
	padding: 5px;
	font-size: smaller;
}
ul.toc {
	margin: 0px 5px 5px 5px;
	padding: 0px;
}
ul.toc li {
	font-size: 85%;
	margin: 1px 0 1px 1px;
	padding: 1px 0 1px 11px;
	list-style-type: none;
	background-repeat: no-repeat;
	background-position: center left;
}
ul.toc li.header {
	font-size: 115%;
	padding: 5px 0px 5px 11px;
	border-bottom: 1px solid #cccccc;
	margin-bottom: 5px;
}
ul.toc li.active {
	font-weight: bold;
}
ul.toc li a {
	text-decoration: none;
}
ul.toc li a:hover {
	text-decoration: underline;
}
</style>
 <ul class="toc">
  <li class="header home"><a href="index.html">PHP Manual</a></li>
  <li class="header up"><a href="funcref.html">Function Reference</a></li>
  <li class="header up"><a href="refs.remote.other.html">Other Services</a></li>
  <li class="header up"><a href="book.event.html">Event</a></li>
  <li class="header up"><a href="class.eventhttpconnection.html">EventHttpConnection</a></li>
  <li><a href="eventhttpconnection.construct.html">EventHttpConnection::__construct</a></li>
  <li><a href="eventhttpconnection.getbase.html">EventHttpConnection::getBase</a></li>
  <li><a href="eventhttpconnection.getpeer.html">EventHttpConnection::getPeer</a></li>
  <li><a href="eventhttpconnection.makerequest.html">EventHttpConnection::makeRequest</a></li>
  <li class="active"><a href="eventhttpconnection.setclosecallback.html">EventHttpConnection::setCloseCallback</a></li>
  <li><a href="eventhttpconnection.setlocaladdress.html">EventHttpConnection::setLocalAddress</a></li>
  <li><a href="eventhttpconnection.setlocalport.html">EventHttpConnection::setLocalPort</a></li>
  <li><a href="eventhttpconnection.setmaxbodysize.html">EventHttpConnection::setMaxBodySize</a></li>
  <li><a href="eventhttpconnection.setmaxheaderssize.html">EventHttpConnection::setMaxHeadersSize</a></li>
  <li><a href="eventhttpconnection.setretries.html">EventHttpConnection::setRetries</a></li>
  <li><a href="eventhttpconnection.settimeout.html">EventHttpConnection::setTimeout</a></li>
 </ul>

        </td>
        <td width="85%">
            <div style="text-align: center;">
                <div class="prev" style="text-align: left; float: left;"><a href="eventhttpconnection.makerequest.html">EventHttpConnection::makeRequest</a></div>
                <div class="next" style="text-align: right; float: right;"><a href="eventhttpconnection.setlocaladdress.html">EventHttpConnection::setLocalAddress</a></div>
                <div class="up"><a href="class.eventhttpconnection.html">EventHttpConnection</a></div>
                <div class="home"><a href="index.html">PHP Manual</a></div>
            </div><hr/>
<div id="eventhttpconnection.setclosecallback" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">EventHttpConnection::setCloseCallback</h1>
  <p class="refpurpose">Set callback for connection close</p>
 </div>
 <div class="refsect1 description" id="refsect1-eventhttpconnection.setclosecallback-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span>
   <span class="type">void</span>
    <span class="methodname">EventHttpConnection::setCloseCallback</span>
    ( <span class="methodparam">
    <span class="type">callable</span>
     <code class="parameter">$callback</code>
   </span>
   [, <span class="methodparam">
    <span class="type">mixed</span>
     <code class="parameter">$data</code>
   </span>
  ] )</div>

  <p class="para rdfs-comment">
   Sets callback for connection close.
  </p>
 </div>

 <div class="refsect1 parameters" id="refsect1-eventhttpconnection.setclosecallback-parameters">
  <h3 class="title">Parameters</h3>
  <dl>

   
    <dt>

     <code class="parameter">callback</code>
    </dt>

    <dd>

     <p class="para">
      Callback which is called when connection is closed. Should match the
      following prototype:
     </p>
     <div class="methodsynopsis dc-description">
      <span class="type">void</span>
       <span class="methodname">callback</span>
       ([ <span class="methodparam">
       <span class="type">EventHttpConnection</span>
        <code class="parameter">$conn</code>
       <span class="initializer"> = <strong><code>NULL</code></strong></span>
      </span>
      [, <span class="methodparam">
       <span class="type">mixed</span>
        <code class="parameter">$arg</code>
       <span class="initializer"> = <strong><code>NULL</code></strong></span>
      </span>
     ]] )</div>

    </dd>

   
  </dl>

 </div>

 <div class="refsect1 returnvalues" id="refsect1-eventhttpconnection.setclosecallback-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   No value is returned.
  </p>
 </div>

 <div class="refsect1 examples" id="refsect1-eventhttpconnection.setclosecallback-examples">
  <h3 class="title">Examples</h3>
  <div class="example" id="example-4852">
   <p><strong>Example #1 
     <span class="methodname">EventHttpConnection::setCloseCallback</span> example</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*<br />&nbsp;*&nbsp;Setting&nbsp;up&nbsp;close-connection&nbsp;callback<br />&nbsp;*<br />&nbsp;*&nbsp;The&nbsp;script&nbsp;handles&nbsp;closed&nbsp;connections&nbsp;using&nbsp;HTTP&nbsp;API.<br />&nbsp;*<br />&nbsp;*&nbsp;Usage:<br />&nbsp;*&nbsp;1)&nbsp;Launch&nbsp;the&nbsp;server:<br />&nbsp;*&nbsp;$&nbsp;php&nbsp;examples/http_closecb.php&nbsp;4242<br />&nbsp;*<br />&nbsp;*&nbsp;2)&nbsp;Launch&nbsp;a&nbsp;client&nbsp;in&nbsp;another&nbsp;terminal.&nbsp;Telnet-like<br />&nbsp;*&nbsp;session&nbsp;should&nbsp;look&nbsp;like&nbsp;the&nbsp;following:<br />&nbsp;*<br />&nbsp;*&nbsp;$&nbsp;nc&nbsp;-t&nbsp;127.0.0.1&nbsp;4242<br />&nbsp;*&nbsp;GET&nbsp;/&nbsp;HTTP/1.0<br />&nbsp;*&nbsp;Connection:&nbsp;close<br />&nbsp;*<br />&nbsp;*&nbsp;The&nbsp;server&nbsp;will&nbsp;output&nbsp;something&nbsp;similar&nbsp;to&nbsp;the&nbsp;following:<br />&nbsp;*<br />&nbsp;*&nbsp;HTTP/1.0&nbsp;200&nbsp;OK<br />&nbsp;*&nbsp;Content-Type:&nbsp;multipart/x-mixed-replace;boundary=boundarydonotcross<br />&nbsp;*&nbsp;Connection:&nbsp;close<br />&nbsp;*<br />&nbsp;*&nbsp;&lt;html&gt;<br />&nbsp;*<br />&nbsp;*&nbsp;3)&nbsp;Terminate&nbsp;the&nbsp;client&nbsp;connection&nbsp;abruptly,<br />&nbsp;*&nbsp;i.e.&nbsp;kill&nbsp;the&nbsp;process,&nbsp;or&nbsp;just&nbsp;press&nbsp;Ctrl-C.<br />&nbsp;*<br />&nbsp;*&nbsp;4)&nbsp;Check&nbsp;if&nbsp;the&nbsp;server&nbsp;called&nbsp;_close_callback.<br />&nbsp;*&nbsp;The&nbsp;script&nbsp;should&nbsp;output&nbsp;"_close_callback"&nbsp;string&nbsp;to&nbsp;standard&nbsp;output.<br />&nbsp;*<br />&nbsp;*&nbsp;5)&nbsp;Check&nbsp;if&nbsp;the&nbsp;server's&nbsp;process&nbsp;has&nbsp;no&nbsp;orphaned&nbsp;connections,<br />&nbsp;*&nbsp;e.g.&nbsp;with&nbsp;`lsof`&nbsp;utility.<br />&nbsp;*/<br /><br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">_close_callback</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">__FUNCTION__</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">PHP_EOL</span><span style="color: #007700">;<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">_http_default</span><span style="color: #007700">(</span><span style="color: #0000BB">$req</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$dummy</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$conn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getConnection</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$conn</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setCloseCallback</span><span style="color: #007700">(</span><span style="color: #DD0000">'_close_callback'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*<br />&nbsp;&nbsp;&nbsp;&nbsp;By&nbsp;enabling&nbsp;Event::READ&nbsp;we&nbsp;protect&nbsp;the&nbsp;server&nbsp;against&nbsp;unclosed&nbsp;conections.<br />&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;peculiarity&nbsp;of&nbsp;Libevent.&nbsp;The&nbsp;library&nbsp;disables&nbsp;Event::READ&nbsp;events<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on&nbsp;this&nbsp;connection,&nbsp;and&nbsp;the&nbsp;server&nbsp;is&nbsp;not&nbsp;notified&nbsp;about&nbsp;terminated<br />&nbsp;&nbsp;&nbsp;&nbsp;connections.<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;So&nbsp;each&nbsp;time&nbsp;client&nbsp;terminates&nbsp;connection&nbsp;abruptly,&nbsp;we&nbsp;get&nbsp;an&nbsp;orphaned<br />&nbsp;&nbsp;&nbsp;&nbsp;connection.&nbsp;For&nbsp;instance,&nbsp;the&nbsp;following&nbsp;is&nbsp;a&nbsp;part&nbsp;of&nbsp;`lsof&nbsp;-p&nbsp;$PID&nbsp;|&nbsp;grep&nbsp;TCP`<br />&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;after&nbsp;client&nbsp;has&nbsp;terminated&nbsp;connection:<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;57-php&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15057&nbsp;ruslan&nbsp;&nbsp;6u&nbsp;&nbsp;unix&nbsp;0xffff8802fb59c780&nbsp;&nbsp;&nbsp;0t0&nbsp;&nbsp;125187&nbsp;socket<br />&nbsp;&nbsp;&nbsp;&nbsp;58:php&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15057&nbsp;ruslan&nbsp;&nbsp;7u&nbsp;&nbsp;IPv4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;125189&nbsp;&nbsp;&nbsp;0t0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP&nbsp;*:4242&nbsp;(LISTEN)<br />&nbsp;&nbsp;&nbsp;&nbsp;59:php&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15057&nbsp;ruslan&nbsp;&nbsp;8u&nbsp;&nbsp;IPv4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;124342&nbsp;&nbsp;&nbsp;0t0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP&nbsp;localhost:4242-&gt;localhost:37375&nbsp;(CLOSE_WAIT)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;$PID&nbsp;is&nbsp;our&nbsp;process&nbsp;ID.<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;following&nbsp;block&nbsp;of&nbsp;code&nbsp;fixes&nbsp;such&nbsp;kind&nbsp;of&nbsp;orphaned&nbsp;connections.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$bev&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$req</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getBufferEvent</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$bev</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">enable</span><span style="color: #007700">(</span><span style="color: #0000BB">Event</span><span style="color: #007700">::</span><span style="color: #0000BB">READ</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;We&nbsp;have&nbsp;to&nbsp;free&nbsp;it&nbsp;explicitly.&nbsp;See</span>
</span>
</code></div>
     <span class="methodname">EventHttpRequest::getConnection</span>
<div class="phpcode"><code><span style="color: #000000">
$bev-&gt;free();&nbsp;//&nbsp;we&nbsp;have&nbsp;to&nbsp;free&nbsp;it&nbsp;explicitly<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;addHeader(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'multipart/x-mixed-replace;boundary=boundarydonotcross',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EventHttpRequest::OUTPUT_HEADER<br />&nbsp;&nbsp;&nbsp;&nbsp;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;$buf&nbsp;=&nbsp;new&nbsp;EventBuffer();<br />&nbsp;&nbsp;&nbsp;&nbsp;$buf-&gt;add('&lt;html&gt;');<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;sendReply(200,&nbsp;"OK");<br />&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;sendReplyChunk($buf);<br />}<br /><br />$port&nbsp;=&nbsp;4242;<br />if&nbsp;($argc&nbsp;&gt;&nbsp;1)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;$port&nbsp;=&nbsp;(int)&nbsp;$argv[1];<br />}<br />if&nbsp;($port&nbsp;&lt;=&nbsp;0&nbsp;||&nbsp;$port&nbsp;&gt;&nbsp;65535)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;exit("Invalid&nbsp;port");<br />}<br /><br />$base&nbsp;=&nbsp;new&nbsp;EventBase();<br />$http&nbsp;=&nbsp;new&nbsp;EventHttp($base);<br /><br />$http-&gt;setDefaultCallback("_http_default",&nbsp;NULL);<br />$http-&gt;bind("0.0.0.0",&nbsp;$port);<br />$base-&gt;loop();<br /><br />?&gt;</span>
</code></div>
   </div>

  </div>
 </div>

</div>
        </td>
    </tr>
</table>
</body>
</html>
