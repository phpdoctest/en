<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>PHP Manual: Querying</title>

</head>
<body>
<table width="100%">
    <tr valign="top">
        <td style="font-size: smaller;" width="15%">
<style type="text/css">
#leftbar {
	float: left;
	width: 186px;
	padding: 5px;
	font-size: smaller;
}
ul.toc {
	margin: 0px 5px 5px 5px;
	padding: 0px;
}
ul.toc li {
	font-size: 85%;
	margin: 1px 0 1px 1px;
	padding: 1px 0 1px 11px;
	list-style-type: none;
	background-repeat: no-repeat;
	background-position: center left;
}
ul.toc li.header {
	font-size: 115%;
	padding: 5px 0px 5px 11px;
	border-bottom: 1px solid #cccccc;
	margin-bottom: 5px;
}
ul.toc li.active {
	font-weight: bold;
}
ul.toc li a {
	text-decoration: none;
}
ul.toc li a:hover {
	text-decoration: underline;
}
</style>
 <ul class="toc">
  <li class="header home"><a href="index.html">PHP Manual</a></li>
  <li class="header up"><a href="funcref.html">Function Reference</a></li>
  <li class="header up"><a href="refs.database.html">Database Extensions</a></li>
  <li class="header up"><a href="refs.database.vendors.html">Vendor Specific Database Extensions</a></li>
  <li class="header up"><a href="book.mongo.html">Mongo</a></li>
  <li class="header up"><a href="mongo.manual.html">Manual</a></li>
  <li><a href="mongo.tutorial.html">Tutorial</a></li>
  <li><a href="mongo.readpreferences.html">Read Preferences</a></li>
  <li><a href="mongo.writeconcerns.html">Write Concerns</a></li>
  <li><a href="mongo.sqltomongo.html">SQL to Mongo Mapping Chart</a></li>
  <li><a href="mongo.connecting.html">Connecting</a></li>
  <li><a href="mongo.context.html">Stream Context Options</a></li>
  <li><a href="mongo.writes.html">Writes</a></li>
  <li class="active"><a href="mongo.queries.html">Querying</a></li>
  <li><a href="mongo.updates.html">Updates</a></li>
  <li><a href="mongo.security.html">Security</a></li>
  <li><a href="mongo.trouble.html">Troubleshooting</a></li>
  <li><a href="mongo.testing.html">Running the Driver's Tests</a></li>
 </ul>

        </td>
        <td width="85%">
            <div style="text-align: center;">
                <div class="prev" style="text-align: left; float: left;"><a href="mongo.writes.html">Writes</a></div>
                <div class="next" style="text-align: right; float: right;"><a href="mongo.updates.html">Updates</a></div>
                <div class="up"><a href="mongo.manual.html">Manual</a></div>
                <div class="home"><a href="index.html">PHP Manual</a></div>
            </div><hr/>
<div id="mongo.queries" class="chapter">
 <h1>Querying</h1>

 <div class="simplesect" id="mongo.queries.secondaries">
  <h1 class="title">Distributing queries to secondaries</h1>

  <p class="para">
   All queries (reads and writes) are only sent to the primary member of a
   replica set by default. This is however easily configurable by using the
   <a href="mongo.readpreferences.html" class="link">Read Preferences</a> which allow
   you to set some generic read preferences (such as allowing secondary reads
   of the nearest server), and also provide ways to specifically target a
   server in a specific country, datacenter, or even hardware, by the use of
   <a href="mongo.readpreferences.html#mongo.readpreferences.tagsets" class="link">replica set tag sets</a>.
  </p>
  <p class="para">
   Read preferences can be configured at every level of the driver:
   <ul class="simplelist">
    <li class="member">As a query parameter or option to  <span class="methodname">MongoClient::__construct</span></li>
    <li class="member">Specifically by calling  <span class="methodname">MongoClient::setReadPreference</span></li>
    <li class="member">At the database level with  <span class="methodname">MongoDB::setReadPreference</span></li>
    <li class="member">At the collection level with  <span class="methodname">MongoCollection::setReadPreference</span></li>
    <li class="member">At the cursor level with  <span class="methodname">MongoCursor::setReadPreference</span> or  <span class="methodname">MongoCommandCursor::setReadPreference</span></li>
   </ul>
   Each class inherits its read preference setting from the &quot;parent&quot; context.
  </p>
  <div class="example" id="mongo.connecting.context.ssl">
   <p><strong>Example #1 Inheriting read preferences from the database level down to the cursor</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setReadPreference</span><span style="color: #007700">(</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">::</span><span style="color: #0000BB">RP_SECONDARY_PREFERRED</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">myCollection</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  <p class="para">
   In this example, the the query will be executed against a secondary. The
   collection inherits <strong><code>MongoClient::RP_SECONDARY_PREFERRED</code></strong>
   from the database and the cursor inherits it from the collection.
  </p>
 </div>

  <div class="simplesect" id="mongo.queries.choosing.secondary">
   <h1 class="title">How secondaries are chosen</h1>

   <p class="para">
    Each instance of <span class="classname">MongoClient</span> chooses its own
    secondary using the available secondary with the lowest ping time. So, if we
    had a PHP client in Europe and one in Australia and we had one secondary in
    each of these data centers, we could do:
   </p>
   <div class="example" id="mongo.connecting.context.ssl.verify">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$options&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"replicaSet"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"setName"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"readPreference"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">::</span><span style="color: #0000BB">RP_SECONDARY_PREFERRED</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;on&nbsp;the&nbsp;Australian&nbsp;client<br /></span><span style="color: #0000BB">$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"mongodb://primary,australianhost.secondary,europeanhost.secondary"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$options</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">foo</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bar</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getNext</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">"Reading&nbsp;from:&nbsp;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">info</span><span style="color: #007700">()[</span><span style="color: #DD0000">"server"</span><span style="color: #007700">],&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;on&nbsp;the&nbsp;European&nbsp;client<br /></span><span style="color: #0000BB">$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"mongodb://primary,australianhost.secondary,europeanhost.secondary"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$options</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">foo</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bar</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getNext</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">"Reading&nbsp;from:&nbsp;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">info</span><span style="color: #007700">()[</span><span style="color: #DD0000">"server"</span><span style="color: #007700">],&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output
something similar to:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Reading from: australianHost
Reading from: europeanHost
</pre></div>
    </div>
    <div class="example-contents"><p>
     Note that we have to do a query before a secondary is chosen: secondaries
     are chosen lazily by the driver, and for each query separately.
    </p></div>
   </div>

   <p class="para">
    You can see what the driver thinks is the current status of the set
    members by running  <span class="methodname">MongoClient::getHosts</span> or
     <span class="methodname">MongoClient::getConnections</span>.
   </p>

   <p class="para">
    If no secondary is readable, the driver will send reads to the
    primary as we specified
    <strong><code>MongoClient::RP_SECONDARY_PREFERRED</code></strong> which will
    fallback to execute a query on a primary if no secondaries are available.
    A server is considered readable if its state is 2 (SECONDARY) and its
    health is 1.  You can check this with
     <span class="methodname">MongoClient::getHosts</span> and
     <span class="methodname">MongoClient::getConnections</span>.
   </p>

  </div>
  <div class="simplesect" id="mongo.queries.notes">
   <h1 class="title">Random notes</h1>

   <p class="para">
    Writes are always sent to the primary—and by default all reads are sent
    to the primary too.
   </p>

  </div>

 <div class="simplesect" id="mongo.queries.querying">
  <h1 class="title">Querying by _id</h1>
  <p class="para">
   Every object inserted is automatically assigned a unique
   <em>_id</em> field, which is often a useful field to use in
   queries. This works similarly to &quot;get last insert ID&quot; functionality, except
   that the <em>_id</em> is chosen by the <em class="emphasis">client</em>.
  </p>
  <p class="para">
   Suppose that we wish to find the document we just inserted.  Inserting adds
   an <em>_id</em> field to the document, so we can query by that:

   <div class="example" id="mongo.connecting.context.ssl.certificate">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$person&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"name"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joe"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$person</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;now&nbsp;$joe&nbsp;has&nbsp;an&nbsp;_id&nbsp;field<br /></span><span style="color: #0000BB">$joe&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$person</span><span style="color: #007700">[</span><span style="color: #DD0000">'_id'</span><span style="color: #007700">]));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   Unless the user has specified otherwise, the <em>_id</em> field is a
   <span class="classname">MongoId</span>.  The most common mistake is attempting to use
   a string to match a <span class="classname">MongoId</span>.  Keep in mind that these
   are two different datatypes, and will not match each other in the same way
   that the string &quot;array()&quot; is not the same as an empty array.  For example:

   <div class="example" id="mongo.connecting.authenticate.ssl.x509">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$person&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"name"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joe"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$person</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;convert&nbsp;the&nbsp;_id&nbsp;to&nbsp;a&nbsp;string<br /></span><span style="color: #0000BB">$pid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$person</span><span style="color: #007700">[</span><span style="color: #DD0000">'_id'</span><span style="color: #007700">]&nbsp;.&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;FAILS&nbsp;-&nbsp;$pid&nbsp;is&nbsp;a&nbsp;string,&nbsp;not&nbsp;a&nbsp;MongoId<br /></span><span style="color: #0000BB">$joe&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$pid</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 <div class="simplesect" id="mongo.queries.arrays">
  <h1 class="title">Arrays</h1>

  <p class="para">
   Arrays are special in a couple ways.  First, there are two types that
   MongoDB uses: &quot;normal&quot; arrays and associative arrays.  Associative arrays can
   have any mix of key types and values.  &quot;Normal&quot; arrays are defined as arrays
   with ascending numeric indexes starting at 0 and increasing by one for each
   element.  These are, typically, just your usual PHP array.
  </p>

  <p class="para">
   For instance, if you want to save a list of awards in a document, you could
   say:
  </p>

  <div class="example" id="mongo.connecting.auth-example">
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"silver"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"bronze"</span><span style="color: #007700">)));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>

  <p class="para">
   Queries can reach into arrays to search for elements.  Suppose that we wish
   to find all documents with an array element of a given value. For example,
   documents with a &quot;gold&quot; award, such as:
  </p>

  <div class="example-contents screen">
<div class="cdata"><pre>
{ &quot;_id&quot; : ObjectId(&quot;4b06c282edb87a281e09dad9&quot;), &quot;awards&quot; : [&quot;gold&quot;, &quot;silver&quot;, &quot;bronze&quot;]}
</pre></div>
  </div>

  <p class="para">
   This can be done with a simple query, ignoring the fact that &quot;awards&quot; is an
   array:
  </p>

   <div class="example" id="mongo.connecting.auth-db-example">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />&nbsp;&nbsp;$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>

  <p class="para">
   Suppose we are querying for a more complex object, if each element of the
   array were an object itself, such as:
  </p>

  <div class="example-contents screen">
<div class="cdata"><pre>
{
     &quot;_id&quot; : ObjectId(&quot;4b06c282edb87a281e09dad9&quot;),
     &quot;awards&quot; :
     [
        {
            &quot;first place&quot; : &quot;gold&quot;
        },
        {
            &quot;second place&quot; : &quot;silver&quot;
        },
        {
            &quot;third place&quot; :  &quot;bronze&quot;
        }
     ]
}
</pre></div>
  </div>

  <p class="para">
   Still ignoring that this is an array, we can use dot notation to query the
   subobject:
  </p>

   <div class="example" id="mongo.connecting.rs-example">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards.first&nbsp;place"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>

  <p class="para">
   Notice that it doesn&#039;t matter that there is a space in the field name
   (although it may be best not to use spaces, just to make things more
   readable).
  </p>

  <p class="para">
   You can also use an array to query for a number of possible values.  For
   instance, if we were looking for documents &quot;gold&quot; or &quot;copper&quot;, we could do:
  </p>

  <div class="example" id="mongo.connecting.rs-example-wrong-replset">
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$in'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"copper"</span><span style="color: #007700">))));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </div>

 <div class="simplesect">
  <h1 class="title">Changelog</h1>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>Version</th>
      <th>Description</th>
     </tr>

    </thead>

    <tbody class="tbody">

     <tr>
      <td>1.3.0</td>
      <td>
       Introduced the <a href="mongo.readpreferences.html" class="link">Read
       Preferences</a> framework to allow more fine grained control over
       secondary reads.
      </td>
     </tr>

     <tr>
      <td>1.3.0</td>
      <td>
       Deprecated <em>slaveOkay</em> usage, the alternative is <a href="mongo.readpreferences.html" class="link">Read Preferences</a>.
      </td>
     </tr>

     <tr>
      <td>1.1.0</td>
      <td>
       Introduced the possiblity of routing reads to secondaries of replica set
       members using  <span class="methodname">Mongo::setSlaveOkay</span>
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>

</div>
        </td>
    </tr>
</table>
</body>
</html>
