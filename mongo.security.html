<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>PHP Manual: Security</title>

</head>
<body>
<table width="100%">
    <tr valign="top">
        <td style="font-size: smaller;" width="15%">
<style type="text/css">
#leftbar {
	float: left;
	width: 186px;
	padding: 5px;
	font-size: smaller;
}
ul.toc {
	margin: 0px 5px 5px 5px;
	padding: 0px;
}
ul.toc li {
	font-size: 85%;
	margin: 1px 0 1px 1px;
	padding: 1px 0 1px 11px;
	list-style-type: none;
	background-repeat: no-repeat;
	background-position: center left;
}
ul.toc li.header {
	font-size: 115%;
	padding: 5px 0px 5px 11px;
	border-bottom: 1px solid #cccccc;
	margin-bottom: 5px;
}
ul.toc li.active {
	font-weight: bold;
}
ul.toc li a {
	text-decoration: none;
}
ul.toc li a:hover {
	text-decoration: underline;
}
</style>
 <ul class="toc">
  <li class="header home"><a href="index.html">PHP Manual</a></li>
  <li class="header up"><a href="funcref.html">Function Reference</a></li>
  <li class="header up"><a href="refs.database.html">Database Extensions</a></li>
  <li class="header up"><a href="refs.database.vendors.html">Vendor Specific Database Extensions</a></li>
  <li class="header up"><a href="book.mongo.html">Mongo</a></li>
  <li class="header up"><a href="mongo.manual.html">Manual</a></li>
  <li><a href="mongo.tutorial.html">Tutorial</a></li>
  <li><a href="mongo.readpreferences.html">Read Preferences</a></li>
  <li><a href="mongo.writeconcerns.html">Write Concerns</a></li>
  <li><a href="mongo.sqltomongo.html">SQL to Mongo Mapping Chart</a></li>
  <li><a href="mongo.connecting.html">Connecting</a></li>
  <li><a href="mongo.context.html">Stream Context Options</a></li>
  <li><a href="mongo.writes.html">Writes</a></li>
  <li><a href="mongo.queries.html">Querying</a></li>
  <li><a href="mongo.updates.html">Updates</a></li>
  <li class="active"><a href="mongo.security.html">Security</a></li>
  <li><a href="mongo.trouble.html">Troubleshooting</a></li>
  <li><a href="mongo.testing.html">Running the Driver's Tests</a></li>
 </ul>

        </td>
        <td width="85%">
            <div style="text-align: center;">
                <div class="prev" style="text-align: left; float: left;"><a href="mongo.updates.html">Updates</a></div>
                <div class="next" style="text-align: right; float: right;"><a href="mongo.trouble.html">Troubleshooting</a></div>
                <div class="up"><a href="mongo.manual.html">Manual</a></div>
                <div class="home"><a href="index.html">PHP Manual</a></div>
            </div><hr/>
<div id="mongo.security" class="chapter">
 <h1>Security</h1>

 <div class="section">
  <h2 class="title">Request Injection Attacks</h2>
  <p class="para">
   If you are passing <em>$_GET</em> (or <em>$_POST</em>)
   parameters to your queries, make sure that they are cast to strings first.
   Users can insert associative arrays in GET and POST requests, which could
   then become unwanted $-queries.
  </p>

  <p class="para">
   A fairly innocuous example: suppose you are looking up a user&#039;s information
   with the request <em class="emphasis">http://www.example.com?username=bob</em>.
   Your application does the query
   <em>$collection-&gt;find(array(&quot;username&quot; =&gt; $_GET[&#039;username&#039;]))</em>.
  </p>

  <p class="para">
   Someone could subvert this by getting
   <em class="emphasis">http://www.example.com?username[$ne]=foo</em>, which PHP
   will magically turn into an associative array, turning your query into
   <em>$collection-&gt;find(array(&quot;username&quot; =&gt; array(&#039;$ne&#039; =&gt; &quot;foo&quot;)))</em>,
   which will return all users not named &quot;foo&quot; (all of your users, probably).
  </p>

  <p class="para">
   This is a fairly easy attack to defend against: make sure $_GET and $_POST
   parameters are the type you expect before you send them to the database
   (cast them to strings, in this case).
  </p>

  <p class="para">
   Note that this type of attack can be used with any databases interation that
   locates a document, including updates, upserts, find-and-modifies, and
   removes.
  </p>

  <p class="para">
   Thanks to <a href="https://www.idontplaydarts.com/2010/07/mongodb-is-vulnerable-to-sql-injection-in-php-at-least/" class="link external">&raquo;&nbsp;Phil</a> for pointing this out.
  </p>

  <p class="para">
   See <a href="https://docs.mongodb.com/manual/security/" class="link external">&raquo;&nbsp;the main documentation</a>
   for more information about SQL-injection-like issues with MongoDB.
  </p>
 </div>

 <div class="section">
  <h2 class="title">Script Injection Attacks</h2>
  <p class="para">
   If you are using JavaScript, make sure that any variables that cross the PHP-
   to-JavaScript boundry are passed in the <em>scope</em> field of
   <span class="classname">MongoCode</span>, not interpolated into the JavaScript
   string. This can come up when using <span class="function">MongoDB::execute</span>,
   <em>$where</em> clauses, MapReduces, group-bys, and any other time
   you may pass JavaScript into the database.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    MapReduce ignore the <em>scope</em> field of
    <span class="classname">MongoCode</span>, but there is a <em>scope</em>
    option on the command that can be used instead.
   </p>
  </p></blockquote>
  <p class="para">
   For example, suppose we have some JavaScript to greet a user in the database
   logs.  We could do:
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;don't&nbsp;do&nbsp;this!<br /><br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'username'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(</span><span style="color: #DD0000">"print('Hello,&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">!');"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   However, what if a malicious user passes in some JavaScript?
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;don't&nbsp;do&nbsp;this!<br /><br />//&nbsp;$username&nbsp;is&nbsp;set&nbsp;to&nbsp;"');&nbsp;db.users.drop();&nbsp;print('"<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(</span><span style="color: #DD0000">"print('Hello,&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">!');"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Now MongoDB executes the JavaScript string
   <em>&quot;print(&#039;Hello, &#039;); db.users.drop(); print(&#039;!&#039;);&quot;</em>.
   This attack is easy to avoid: use <em>scope</em> to pass
   variables from PHP to JavaScript:
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$scope&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"user"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">MongoCode</span><span style="color: #007700">(</span><span style="color: #DD0000">"print('Hello,&nbsp;'+user+'!');"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$scope</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   This adds a variable <em>user</em> to the JavaScript scope. Now if
   someone tries to send malicious code, MongoDB will harmlessly print
   <em>Hello, &#039;); db.dropDatabase(); print(&#039;!</em>.
  </p>

  <p class="para">
   Using <em>scope</em> helps prevent malicious input from being
   executed by the database.  However, you must make sure that your code does
   not turn around and execute the input anyway! For example, never use the
   JavaScript <em>eval</em> function on user input:
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;don't&nbsp;do&nbsp;this!<br /><br />//&nbsp;$jsShellInput&nbsp;is&nbsp;"db.users.drop();"<br /></span><span style="color: #0000BB">$scope&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"input"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$jsShellInput</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">MongoCode</span><span style="color: #007700">(</span><span style="color: #DD0000">"eval(input);"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$scope</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Always use <em>scope</em> and never allow the database to execute
   user input as code.
  </p>
 </div>
</div>
        </td>
    </tr>
</table>
</body>
</html>
