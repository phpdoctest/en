<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>PHP Manual: Script Injection Attacks</title>

</head>
<body>
<table width="100%">
    <tr valign="top">
        <td style="font-size: smaller;" width="15%">
<style type="text/css">
#leftbar {
	float: left;
	width: 186px;
	padding: 5px;
	font-size: smaller;
}
ul.toc {
	margin: 0px 5px 5px 5px;
	padding: 0px;
}
ul.toc li {
	font-size: 85%;
	margin: 1px 0 1px 1px;
	padding: 1px 0 1px 11px;
	list-style-type: none;
	background-repeat: no-repeat;
	background-position: center left;
}
ul.toc li.header {
	font-size: 115%;
	padding: 5px 0px 5px 11px;
	border-bottom: 1px solid #cccccc;
	margin-bottom: 5px;
}
ul.toc li.active {
	font-weight: bold;
}
ul.toc li a {
	text-decoration: none;
}
ul.toc li a:hover {
	text-decoration: underline;
}
</style>
 <ul class="toc">
  <li class="header home"><a href="index.html">PHP Manual</a></li>
  <li class="header up"><a href="funcref.html">Function Reference</a></li>
  <li class="header up"><a href="refs.database.html">Database Extensions</a></li>
  <li class="header up"><a href="refs.database.vendors.html">Vendor Specific Database Extensions</a></li>
  <li class="header up"><a href="set.mongodb.html">MongoDB</a></li>
  <li class="header up"><a href="mongodb.security.html">Security</a></li>
  <li><a href="mongodb.security.request_injection.html">Request Injection Attacks</a></li>
  <li class="active"><a href="mongodb.security.script_injection.html">Script Injection Attacks</a></li>
 </ul>

        </td>
        <td width="85%">
            <div style="text-align: center;">
                <div class="prev" style="text-align: left; float: left;"><a href="mongodb.security.request_injection.html">Request Injection Attacks</a></div>
                <div class="next" style="text-align: right; float: right;"><a href="book.mongodb.html">MongoDB\Driver</a></div>
                <div class="up"><a href="mongodb.security.html">Security</a></div>
                <div class="home"><a href="index.html">PHP Manual</a></div>
            </div><hr/>
<div id="mongodb.security.script_injection" class="article">
  <h1>Script Injection Attacks</h1>
  <p class="para">
   If you are using JavaScript, make sure that any variables that cross the PHP-
   to-JavaScript boundry are passed in the <em>scope</em> field of
   <span class="classname">MongoDB\BSON\Javascript</span>, not interpolated into the
   JavaScript string. This can come up when using <em>$where</em>
   clauses in queries, mapReduce and group commands, and any other time you may
   pass JavaScript into the database.
  </p>
  <p class="para">
   For example, suppose we have some JavaScript to greet a user in the database
   logs.  We could do:
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoDB</span><span style="color: #007700">\</span><span style="color: #0000BB">Driver</span><span style="color: #007700">\</span><span style="color: #0000BB">Manager</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;Don't&nbsp;do&nbsp;this!!!<br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">];&nbsp;<br /><br /></span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;\</span><span style="color: #0000BB">MongoDB</span><span style="color: #007700">\</span><span style="color: #0000BB">Driver</span><span style="color: #007700">\</span><span style="color: #0000BB">Command</span><span style="color: #007700">(&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'eval'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"print('Hello,&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">!');"<br /></span><span style="color: #007700">]&nbsp;);<br /><br /></span><span style="color: #0000BB">$r&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">executeCommand</span><span style="color: #007700">(&nbsp;</span><span style="color: #DD0000">'dramio'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   However, what if a malicious user passes in some JavaScript?
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoDB</span><span style="color: #007700">\</span><span style="color: #0000BB">Driver</span><span style="color: #007700">\</span><span style="color: #0000BB">Manager</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;Don't&nbsp;do&nbsp;this!!!<br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">];&nbsp;<br /></span><span style="color: #FF8000">//&nbsp;$username&nbsp;is&nbsp;set&nbsp;to&nbsp;"');&nbsp;db.users.drop();&nbsp;print('"<br /><br /></span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;\</span><span style="color: #0000BB">MongoDB</span><span style="color: #007700">\</span><span style="color: #0000BB">Driver</span><span style="color: #007700">\</span><span style="color: #0000BB">Command</span><span style="color: #007700">(&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'eval'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"print('Hello,&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">!');"<br /></span><span style="color: #007700">]&nbsp;);<br /><br /></span><span style="color: #0000BB">$r&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">executeCommand</span><span style="color: #007700">(&nbsp;</span><span style="color: #DD0000">'dramio'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Now MongoDB executes the JavaScript string
   <em>&quot;print(&#039;Hello, &#039;); db.users.drop(); print(&#039;!&#039;);&quot;</em>.
   This attack is easy to avoid: use <em>args</em> to pass
   variables from PHP to JavaScript:
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoDB</span><span style="color: #007700">\</span><span style="color: #0000BB">Driver</span><span style="color: #007700">\</span><span style="color: #0000BB">Manager</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #DD0000">'derick'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$args&nbsp;</span><span style="color: #007700">=&nbsp;[&nbsp;</span><span style="color: #0000BB">$_GET</span><span style="color: #007700">[</span><span style="color: #DD0000">'field'</span><span style="color: #007700">]&nbsp;];<br /><br /></span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;\</span><span style="color: #0000BB">MongoDB</span><span style="color: #007700">\</span><span style="color: #0000BB">Driver</span><span style="color: #007700">\</span><span style="color: #0000BB">Command</span><span style="color: #007700">(&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'eval'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"function&nbsp;greet(username)&nbsp;{&nbsp;print('Hello,&nbsp;'&nbsp;+&nbsp;username&nbsp;+&nbsp;'!');&nbsp;}"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'args'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$args</span><span style="color: #007700">,<br />]&nbsp;);<br /><br /></span><span style="color: #0000BB">$r&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">executeCommand</span><span style="color: #007700">(&nbsp;</span><span style="color: #DD0000">'dramio'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   This adds an argument to the JavaScript scope, which gets used as argument
   for the <em>greet</em> function. Now if
   someone tries to send malicious code, MongoDB will harmlessly print
   <em>Hello, &#039;); db.dropDatabase(); print(&#039;!</em>.
  </p>

  <p class="para">
   Using arguments helps to prevent malicious input from being executed by the
   database.  However, you must make sure that your code does not turn around
   and execute the input anyway! It is best to avoid executing
   <em class="emphasis">any</em> JavaScript on the server in the first place.
  </p>

  <p class="para">
   You are strongly recommended to stay clear of the <a href="https://docs.mongodb.com/manual/reference/operator/query/where/#considerations" class="link external">&raquo;&nbsp;$where
   clause</a> with queries, as it impacts performance significantly. Where
   possible, use either normal query operators, or the <a href="https://docs.mongodb.com/manual/core/aggregation-pipeline" class="link external">&raquo;&nbsp;Aggregation
   Framework</a>.
  </p>

  <p class="para">
   As alternative to <a href="https://docs.mongodb.com/manual/core/map-reduce/" class="link external">&raquo;&nbsp;MapReduce</a>, which uses
   JavaScript, consider using the <a href="https://docs.mongodb.com/manual/core/aggregation-pipeline" class="link external">&raquo;&nbsp;Aggregation
   Framework</a>. Unlike Map/Reduce, it uses an idiomatic language to
   construct queries, without having to write, and use, the slower JavaScript
   approach that Map/Reduce requires.
  </p>

  <p class="para">
   The <a href="https://docs.mongodb.com/manual/reference/command/eval/" class="link external">&raquo;&nbsp;eval command</a>
   has been deprecated since MongoDB 3.0, and should also be avoided.
  </p>
 </div>
        </td>
    </tr>
</table>
</body>
</html>
